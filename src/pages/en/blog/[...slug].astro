---
import { type CollectionEntry, getCollection } from 'astro:content';
import BlogPost from '../../../layouts/BlogPost.astro';

export async function getStaticPaths() {
  const posts = (await getCollection('blog')).filter(p => p.data.lang === 'en');
  const dailiesAsc = posts
    .filter(p => p.id.replace(/^en\//, '').startsWith('openclaw-daily-'))
    .sort((a, b) => a.data.pubDate.valueOf() - b.data.pubDate.valueOf());

  const toSlug = (id: string) => id.replace(/^en\//, '').replace(/\.md$/, '');

  return posts.map((post) => {
    const slug = toSlug(post.id);
    const isDaily = slug.startsWith('openclaw-daily-');

    let prevDaily = null;
    let nextDaily = null;

    if (isDaily) {
      const idx = dailiesAsc.findIndex(p => p.id === post.id);
      if (idx > 0) {
        const prev = dailiesAsc[idx - 1];
        prevDaily = {
          title: prev.data.title,
          href: `/en/blog/${toSlug(prev.id)}/`
        };
      }
      if (idx >= 0 && idx < dailiesAsc.length - 1) {
        const next = dailiesAsc[idx + 1];
        nextDaily = {
          title: next.data.title,
          href: `/en/blog/${toSlug(next.id)}/`
        };
      }
    }

    const relatedPosts = posts
      .filter(candidate => candidate.id !== post.id)
      .map((candidate) => {
        const overlap = candidate.data.tags.filter(tag => post.data.tags.includes(tag)).length;
        return {
          title: candidate.data.title,
          href: `/en/blog/${toSlug(candidate.id)}/`,
          overlap,
          pubDate: candidate.data.pubDate.valueOf(),
        };
      })
      .filter(item => item.overlap > 0)
      .sort((a, b) => (b.overlap - a.overlap) || (b.pubDate - a.pubDate))
      .slice(0, 3)
      .map(({ title, href }) => ({ title, href }));

    return {
      params: { slug },
      props: { ...post, prevDaily, nextDaily, relatedPosts },
    };
  });
}

type Props = CollectionEntry<'blog'> & {
  prevDaily?: { title: string; href: string } | null;
  nextDaily?: { title: string; href: string } | null;
  relatedPosts?: { title: string; href: string }[];
};

const post = Astro.props;
const { Content } = await post.render();
const slug = post.id.replace(/^en\//, '').replace(/\.md$/, '');
---
<BlogPost {...post.data} slug={slug} prevDaily={post.prevDaily} nextDaily={post.nextDaily}>
  <Content />
</BlogPost>
