---
import BaseLayout from './BaseLayout.astro';
import ArticleFeedback from '../components/ArticleFeedback.astro';
import Giscus from '../components/Giscus.astro';
import type { CollectionEntry } from 'astro:content';

type NavLink = { title: string; href: string };
type RelatedPost = { title: string; href: string };
type Props = CollectionEntry<'blog'>['data'] & {
  slug?: string;
  prevDaily?: NavLink | null;
  nextDaily?: NavLink | null;
  relatedPosts?: RelatedPost[];
  faq?: Array<{ question: string; answer: string }>;
};
const { title, description, pubDate, updatedDate, heroImage, tags, lang = 'en', slug, prevDaily, nextDaily, relatedPosts = [], faq = [] } = Astro.props;

const isZh = lang === 'zh';
const dateLocale = isZh ? 'zh-CN' : 'en-US';
const isDailyPost = (slug || '').startsWith('openclaw-daily-');
const canonicalUrl = Astro.url.href;
const siteName = 'AI Agent Hub';
const defaultImage = `${Astro.url.origin}/images/home-hero-cartoon.png`;
const resolvedImage = heroImage
  ? (heroImage.startsWith('http') ? heroImage : `${Astro.url.origin}${heroImage.startsWith('/') ? '' : '/'}${heroImage}`)
  : defaultImage;

const pillarLinks = isZh
  ? [
      { title: 'OpenClaw vs ChatGPT vs Claude：怎么选？', href: '/zh/blog/openclaw-vs-chatgpt-vs-claude/' },
      { title: '什么是 OpenClaw？一文看懂核心能力', href: '/zh/blog/what-is-openclaw/' },
      { title: 'OpenClaw 模型回退策略：稳定性实战', href: '/zh/blog/openclaw-model-fallback-strategy/' },
    ]
  : [
      { title: 'OpenClaw vs ChatGPT vs Claude: Which One Should You Choose?', href: '/en/blog/openclaw-vs-chatgpt-vs-claude/' },
      { title: 'What Is OpenClaw? Core Concepts and Practical Use Cases', href: '/en/blog/what-is-openclaw/' },
      { title: 'OpenClaw Model Fallback Strategy: Reliability in Production', href: '/en/blog/openclaw-model-fallback-strategy/' },
    ];

const normalizedSlug = `/${lang}/blog/${slug || ''}/`;
const contextualGuideLinks = pillarLinks.filter((item) => item.href !== normalizedSlug);

// Build alternate URL
const otherLang = isZh ? 'en' : 'zh';
const baseSlug = slug || '';
const alternateUrl = `/${otherLang}/blog/${baseSlug}/`;

const organizationSchema = {
  '@type': 'Organization',
  name: siteName,
  url: Astro.url.origin,
  logo: `${Astro.url.origin}/images/home-hero-cartoon.png`,
};

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description,
  image: [resolvedImage],
  keywords: tags,
  datePublished: pubDate.toISOString(),
  ...(updatedDate ? { dateModified: updatedDate.toISOString() } : {}),
  inLanguage: lang,
  mainEntityOfPage: canonicalUrl,
  author: organizationSchema,
  publisher: organizationSchema,
};

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: isZh ? '首页' : 'Home',
      item: `${Astro.url.origin}/${lang}/`,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: isZh ? '文章' : 'Articles',
      item: `${Astro.url.origin}/${lang}/blog/`,
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: title,
      item: canonicalUrl,
    },
  ],
};

const faqSchema = faq.length > 0 ? {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faq.map((item) => ({
    '@type': 'Question',
    name: item.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: item.answer,
    },
  })),
} : null;
---
<BaseLayout title={title} description={description} lang={lang} alternateUrl={alternateUrl} alternateLang={otherLang} ogType="article" ogImage={resolvedImage}>
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  {faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />}
  <article class="card">
    <h1>{title}</h1>
    <div class="meta">
      <time datetime={pubDate.toISOString()}>{pubDate.toLocaleDateString(dateLocale, { year: 'numeric', month: 'long', day: 'numeric' })}</time>
      {updatedDate && <span> · {isZh ? '更新于' : 'Updated'} <time datetime={updatedDate.toISOString()}>{updatedDate.toLocaleDateString(dateLocale, { year: 'numeric', month: 'long', day: 'numeric' })}</time></span>}
    </div>
    <div class="tags">
      {tags.map(tag => <a href={`/${lang}/blog/tag/${tag}/`}><span class="tag">{tag}</span></a>)}
    </div>
    <slot />

    {faq.length > 0 && (
      <section class="faq-section card" style="margin-top:1.5rem;">
        <h3 style="margin:0 0 12px;">{isZh ? '常见问题' : 'Frequently Asked Questions'}</h3>
        {faq.map((item) => (
          <details style="margin-bottom:0.8rem;">
            <summary style="cursor:pointer; font-weight:600; padding:0.4rem 0;">{item.question}</summary>
            <p style="margin:0.4rem 0 0; padding-left:0.5rem; border-left:2px solid var(--accent); color:var(--text-muted);">{item.answer}</p>
          </details>
        ))}
      </section>
    )}

    {contextualGuideLinks.length > 0 && (
      <section class="related-posts card" style="margin-top:1rem;">
        <h3 style="margin:0 0 8px;">{isZh ? '核心指南（推荐）' : 'Core Guides (Recommended)'}</h3>
        <ul style="margin:0; padding-left:1.2rem;">
          {contextualGuideLinks.map((item) => (
            <li style="margin:0.4rem 0;"><a href={item.href}>{item.title}</a></li>
          ))}
        </ul>
      </section>
    )}

    {(prevDaily || nextDaily) && (
      <div class="daily-nav card" style="margin-top:1rem;">
        <h3 style="margin:0 0 8px;">{isZh ? '连续阅读' : 'Continue Reading'}</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          {prevDaily && <a href={prevDaily.href}>← {isZh ? '上一篇' : 'Previous'}：{prevDaily.title}</a>}
          {nextDaily && <a href={nextDaily.href}>{isZh ? '下一篇' : 'Next'}：{nextDaily.title} →</a>}
        </div>
      </div>
    )}

    {isDailyPost && (
      <section class="related-posts card" style="margin-top:1rem;">
        <h3 style="margin:0 0 8px;">{isZh ? '延伸阅读（OpenClaw 专题）' : 'Deep Dives on OpenClaw'}</h3>
        <ul style="margin:0; padding-left:1.2rem;">
          {pillarLinks.map((item) => (
            <li style="margin:0.4rem 0;"><a href={item.href}>{item.title}</a></li>
          ))}
        </ul>
      </section>
    )}

    {relatedPosts.length > 0 && (
      <section class="related-posts card" style="margin-top:1rem;">
        <h3 style="margin:0 0 8px;">{isZh ? '相关文章' : 'Related Posts'}</h3>
        <ul style="margin:0; padding-left:1.2rem;">
          {relatedPosts.map((item) => (
            <li style="margin:0.4rem 0;"><a href={item.href}>{item.title}</a></li>
          ))}
        </ul>
      </section>
    )}

    <ArticleFeedback lang={lang} slug={slug} />
    <Giscus lang={lang} />
  </article>
</BaseLayout>

<style>
  .meta {
    color: var(--text-muted);
    margin: 0.5rem 0 1rem;
    font-size: 0.9rem;
  }
  .tags {
    margin-bottom: 1rem;
  }
  .tags a {
    text-decoration: none;
  }
  .monetization-box p {
    color: var(--text-muted);
    margin-bottom: 0.8rem;
    font-size: 0.9rem;
  }
  .monetization-box ul {
    margin-left: 1.2rem;
  }
  .monetization-box li {
    margin: 0.4rem 0;
  }
</style>
